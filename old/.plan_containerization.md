# RComPlEx Containerization Plan - Apptainer/Singularity

## Current Issue
The pipeline is failing due to Singularity bind mount warnings from RStudio-server environment variables:
```
WARNING: While bind mounting '/work/users/martpali/martpali/rstudio-server-4.4.2:/tmp':
destination is already in the mount point list
```

These warnings are propagating through Nextflow and causing pipeline execution failures.

## Solution Overview
Create Apptainer/Singularity container definitions that:
1. Bundle all R dependencies
2. Avoid RStudio bind mount conflicts
3. Isolate environment variables
4. Enable reproducible execution across systems

---

## Part 1: R Package Dependencies Identified

### Core Data Manipulation & Statistics
- **tidyverse** (8 sub-packages: dplyr, tidyr, ggplot2, readr, purrr, tibble, stringr, forcats)
- **matrixStats** - Efficient matrix operations
- **yaml** - Configuration file parsing
- **optparse** - Command-line argument parsing

### Parallelization & Future Computing
- **furrr** - Functional programming with parallelization
- **future** - Evaluation strategy framework
- **parallel** - Base R parallelization utilities

### Visualization
- **ggplot2** - Graphics (included in tidyverse)
- **RColorBrewer** - Color palettes (used in original Rmd)
- **cowplot** - Plot composition (used in original Rmd)
- **gplots** - Extended plotting (used in original Rmd)
- **DT** - Interactive tables (used in original Rmd)

### System Requirements
- **R >= 4.4.2** (tested version)
- **glibc >= 2.31**
- **libssl** for HTTPS access
- **libcurl** for downloading packages

### Optional/Future Dependencies
- **knitr** - For Rmarkdown rendering (legacy support)
- **rmarkdown** - For HTML reports (legacy support)

---

## Part 2: Container Strategy

### Approach: Multi-Stage Apptainer Recipe
Create a single Apptainer definition file that:

1. **Stage 1: Base Image**
   - Use rocker/tidyverse:4.4.2 (includes R 4.4.2 + tidyverse)
   - Advantage: Pre-built, tested, minimal bloat
   - Already includes: tidyverse, optparse, matrixStats, yaml

2. **Stage 2: Add Dependencies**
   - Install furrr, future, parallel (usually pre-installed)
   - Install visualization packages: gplots, RColorBrewer, cowplot, DT
   - Install any missing utilities (curl, git for reproducibility)

3. **Stage 3: Configuration**
   - Set R_HOME explicitly (avoids RStudio conflicts)
   - Configure container runtime environment
   - Set default environment for reproducibility

### File Structure
```
RComPlEx.def              ← Apptainer recipe
RComPlEx.sif             ← Built container (binary, ~1.5 GB)
apptainer/
  ├── build_container.sh  ← Helper script to build
  └── README.md          ← Container documentation
```

---

## Part 3: Nextflow Integration

### Approach: Profile-Based Container Execution

1. **Current Configuration** (nextflow.config):
   - Singularity disabled: `singularity.enabled = false`
   - No container specification

2. **Proposed Addition** (nextflow.config):
   - Create new profile: `singularity-hpc`
   - Enable: `singularity.enabled = true`
   - Configure: `singularity.cacheDir`, `singularity.autoMounts`
   - Specify container path: `process.container = 'RComPlEx.sif'`

3. **Usage**:
   ```bash
   # With container
   nextflow run main.nf -profile slurm,singularity-hpc --use_ng

   # Without container (current)
   nextflow run main.nf -profile slurm --use_ng
   ```

### Process Container Binding
- All 4 RCOMPLEX_* processes automatically use the container
- Data volumes mounted automatically via `singularity.autoMounts = true`
- Config files accessible within container

---

## Part 4: Implementation Steps

### Step 1: Create Apptainer Recipe
**File**: `RComPlEx.def`
- Base image: rocker/tidyverse:4.4.2
- Install additional packages via `apt-get` and `install.packages()`
- Set R_HOME to avoid conflicts
- Add labels and metadata

### Step 2: Build Container
**File**: `apptainer/build_container.sh`
- Build command: `apptainer build RComPlEx.sif RComPlEx.def`
- Output: ~1.5-2 GB binary container
- Approximately 15-30 minutes to build
- One-time operation

### Step 3: Update Nextflow Configuration
**File**: `nextflow.config`
- Add singularity profile
- Configure caching and mount options
- Test with small job first

### Step 4: Update Main Pipeline
**File**: `main.nf`
- Add container directive to all processes
- Document container requirement
- Update README with container usage

### Step 5: Documentation
**Files**:
- `apptainer/README.md` - Container building and usage
- `CONTAINERIZATION.md` - Integration with Nextflow
- Update main README with container option

---

## Part 5: Advantages of This Approach

| Aspect | Benefit |
|--------|---------|
| **Isolation** | No RStudio/system environment conflicts |
| **Reproducibility** | Same packages across different systems |
| **SLURM Compatible** | Works with existing SLURM profiles |
| **Optional** | Can run with or without container |
| **Standard Format** | Apptainer is standard on HPC clusters |
| **Caching** | Containers cached locally for reuse |
| **Minimal Changes** | Doesn't break existing pipeline code |

---

## Part 6: Potential Challenges & Solutions

### Challenge 1: Container Build Time
- **Solution**: Build once, cache locally
- Estimated: 15-30 minutes
- One-time operation

### Challenge 2: Container Size
- **Solution**: Use rocker base (already optimized)
- Expected size: 1.5-2 GB
- Reasonable for HPC environments

### Challenge 3: Bind Mount Points
- **Solution**: Set `singularity.autoMounts = true` to auto-detect
- Ensure `config/` and data directories accessible
- Test with actual data paths

### Challenge 4: Module Loading Inside Container
- **Solution**: R modules not needed inside container
- All dependencies bundled
- May need to adjust SLURM script if modules are critical

---

## Part 7: Testing Strategy

### Test 1: Build Container
- Execute: `apptainer build RComPlEx.sif RComPlEx.def`
- Verify: Check file exists and size is reasonable

### Test 2: Run Single Step in Container
```bash
apptainer exec RComPlEx.sif \
  Rscript scripts/rcomplex_01_load_filter.R \
  --tissue root --pair_id Test_Test \
  --config config/pipeline_config.yaml \
  --workdir . --outdir /tmp/test
```

### Test 3: Run Single Pair with Nextflow
```bash
nextflow run main.nf -profile slurm,singularity-hpc \
  --tissues root --test_mode \
  -with-report report.html
```

### Test 4: Full Pipeline
```bash
nextflow run main.nf -profile slurm,singularity-hpc --use_ng
```

---

## Part 8: Migration Path

### Phase 1: Container Creation (This Plan)
- [ ] Create RComPlEx.def
- [ ] Build container
- [ ] Test basic functionality

### Phase 2: Nextflow Integration
- [ ] Update nextflow.config
- [ ] Add singularity profile
- [ ] Test with existing data

### Phase 3: Documentation
- [ ] Document building process
- [ ] Update README
- [ ] Provide usage examples

### Phase 4: Transition (Optional)
- [ ] Make singularity default profile
- [ ] Deprecate direct module loading
- [ ] Archive legacy approach

---

## Part 9: File Changes Summary

### New Files to Create (4)
1. `RComPlEx.def` - Apptainer recipe (~100 lines)
2. `apptainer/build_container.sh` - Build helper (~30 lines)
3. `apptainer/README.md` - Container documentation (~150 lines)
4. `CONTAINERIZATION.md` - Integration guide (~200 lines)

### Files to Modify (1)
1. `nextflow.config` - Add singularity profile (~30 lines)

### Optional Modifications
- `main.nf` - Add explicit container directives (for clarity)
- `README.md` - Document container usage

---

## Part 10: Resource Requirements

### Build Time
- Estimated: 20-30 minutes
- Required once
- Can be parallelized on build system

### Disk Space
- Container file: 1.5-2 GB
- Source files: ~100 KB
- Total additional: 1.5-2 GB

### Runtime Overhead
- Container startup: ~1-2 seconds per process
- Bind mounting: Automatic, minimal overhead
- Network I/O: Same as native execution

---

## Implementation Decision Points

### Q1: Use Apptainer (Singularity) or Docker?
**Decision**: Apptainer/Singularity
- Reason: Already commonly used on HPC clusters
- rocker images optimized for Singularity
- No daemon process (better for SLURM)
- Better multi-tenancy on shared systems

### Q2: Single container or per-step containers?
**Decision**: Single container
- Reason: Simpler to maintain
- All steps need same packages anyway
- Faster execution
- Easier to test

### Q3: Public base image or custom?
**Decision**: Public rocker/tidyverse:4.4.2
- Reason: Tested, maintained, minimal
- Already has most dependencies
- Community support
- Reproducible builds

### Q4: Bind mount or copy data?
**Decision**: Bind mount (with autoMounts)
- Reason: Efficient for large datasets
- Works with SLURM
- No data duplication
- Standard HPC practice

---

## Next Steps

**Recommendation**: Proceed with Phase 1 implementation
- Create RComPlEx.def with all identified dependencies
- Build and test locally
- Provide container file and documentation
- Then integrate with Nextflow pipeline

**Expected Timeline**:
- Definition file: 30 minutes
- Build testing: 1 hour
- Nextflow integration: 30 minutes
- Documentation: 30 minutes
- Total: ~2.5 hours

---

**Status**: Ready for user approval to proceed with implementation
